/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds
 */

import groovy.sql.Sql

import java.sql.SQLException

plugins {
    id 'org.liquibase.gradle' version '2.0.3'
    id 'groovy'
}

repositories {
    mavenCentral()
}

configurations {
    jdbc
}

dependencies {
    liquibaseRuntime 'org.liquibase:liquibase-core:3.8.1'
    liquibaseRuntime 'org.liquibase:liquibase-groovy-dsl:2.1.1'
    liquibaseRuntime 'org.postgresql:postgresql:42.2.6'
    jdbc 'org.postgresql:postgresql:42.2.6'
    testImplementation 'org.codehaus.groovy:groovy-all:2.4.15'
    testImplementation 'org.spockframework:spock-core:1.1-groovy-2.4'
    testImplementation 'org.postgresql:postgresql:42.2.6'
}

ext {
    dbHost = System.getenv("POSTGRES_HOST") ?: "localhost"
    dbPort = System.getenv("POSTGRES_PORT") ?: 5432
    dbName = System.getenv("POSTGRES_DB") ?: "postgres"
    dbUser = System.getenv("POSTGRES_USER") ?: "postgres"
    dbPassword = System.getenv("POSTGRES_PASSWORD") ?: "postgres"
    dbUrl = "jdbc:postgresql://$dbHost:$dbPort/$dbName"
}

def changeLog = '$projectDir/src/main/db/changelog.xml'

task waitForDb() {

    doLast {
        for (int i = 0; i < 10; ++i) {
            try {
                def sqlClassLoader = Sql.classLoader
                configurations.jdbc.each { sqlClassLoader.addURL it.toURI().toURL() }
                
                Sql.withInstance(dbUrl, dbUser, dbPassword, 'org.postgresql.Driver') {
                    it.execute("select 1;")
                }

                println "Connected to db ${dbUrl}"
                break

            } catch (SQLException ex) {
                println "Could not connect to db: ${ex.toString()}"
                sleep(1000)
            }
        }
    }
}

liquibase {
    activities {
        main {
            changeLogFile "src/main/db/changelog.xml"
            url dbUrl
            username dbUser
            password dbPassword
            logLevel "off"
        }
    }
}

test {
    
}